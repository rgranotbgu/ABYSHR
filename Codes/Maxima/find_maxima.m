function	[out]=find_maximas(mat1,mat2,mat3,x,x2,y2,y,quads);
%Finds all values that are bigger than their neighbors (3x3 grid). Values
%from blacklisted areas are not returned. Returns a matrix of Nx4, where N
%is the number of max values. 
%the columns are [longtitude, latitude, scale, magnitude_value]

newx=x(2:end-1);
newy=y(2:end-1);
newdata=mat2(2:end-1,2:end-1);
newx2=x2(2:end-1);
newy2=y2(2:end-1);


%find the indices of max value (checks that are bigger than all neighbors
%in a 3x3 grid)
[indsy,indsx]=find(mat2(2:end-1,2:end-1)>mat1(2:end-1,2:end-1) & ...
		  mat2(2:end-1,2:end-1)>mat3(2:end-1,2:end-1) & ...
		  mat2(2:end-1,2:end-1)>mat1(1:end-2,2:end-1) & ...
		  mat2(2:end-1,2:end-1)>mat3(1:end-2,2:end-1) & ...
		  mat2(2:end-1,2:end-1)>mat1(3:end,2:end-1) & ...
		  mat2(2:end-1,2:end-1)>mat3(3:end,2:end-1) & ...
		  mat2(2:end-1,2:end-1)>mat1(2:end-1,1:end-2) & ...
		  mat2(2:end-1,2:end-1)>mat3(2:end-1,1:end-2) & ...
		  mat2(2:end-1,2:end-1)>mat1(1:end-2,1:end-2) & ...
		  mat2(2:end-1,2:end-1)>mat3(1:end-2,1:end-2) & ...
		  mat2(2:end-1,2:end-1)>mat1(3:end,1:end-2) & ...
		  mat2(2:end-1,2:end-1)>mat3(3:end,1:end-2) & ...
		  mat2(2:end-1,2:end-1)>mat1(2:end-1,3:end) & ...
		  mat2(2:end-1,2:end-1)>mat3(2:end-1,3:end) & ...
		  mat2(2:end-1,2:end-1)>mat1(1:end-2,3:end) & ...
		  mat2(2:end-1,2:end-1)>mat3(1:end-2,3:end) & ...
		  mat2(2:end-1,2:end-1)>mat1(3:end,3:end) & ...
		  mat2(2:end-1,2:end-1)>mat3(3:end,3:end) & ...
		  mat2(2:end-1,2:end-1)>mat2(1:end-2,2:end-1) & ...
		  mat2(2:end-1,2:end-1)>mat2(3:end,2:end-1) & ...
		  mat2(2:end-1,2:end-1)>mat2(1:end-2,1:end-2) & ...
		  mat2(2:end-1,2:end-1)>mat2(2:end-1,1:end-2) & ...
		  mat2(2:end-1,2:end-1)>mat2(3:end,1:end-2) & ...
		  mat2(2:end-1,2:end-1)>mat2(1:end-2,3:end) & ...
		  mat2(2:end-1,2:end-1)>mat2(2:end-1,3:end) & ...
		  mat2(2:end-1,2:end-1)>mat2(3:end,3:end));

data_out=zeros(1,length(indsy));

for m=1:length(indsy)
	data_out(m)=newdata(indsy(m),indsx(m));
end

out=[newx2(indsx)' newy2(indsx)' newy(indsy)' data_out'];

%clear out all max values from blacklisted areas
for m=1:length(quads(:,1))
	blind=[find(out(:,1)<quads(m,1) | out(:,1)>quads(m,2) | out(:,2)<quads(m,3) | out(:,2)>quads(m,4))];
	out=out(blind,:);
end


